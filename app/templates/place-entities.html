{% extends "base-canvas.html" %}

{% block page_title %}Manual Entity Placement{% endblock %}
{% block page_subtitle %}Place your manual entities on the canvas{% endblock %}
{% block save_endpoint %}/place-entities{% endblock %}

{% block drawing_tools %}
<select id="structType">
  {% for entity in session.get('placing_entities', []) %}
  <option value="{{ entity.entity_id }}">{{ entity.type }}</option>
  {% endfor %}
</select>
{% endblock %}

{% block legend %}
<div class="legend">
  <h3>Legend</h3>
  {% for entity in session.get('placing_entities', []) %}
  <div><span style="background-color: {{ entity.color }};"></span> {{ entity.type }}</div>
  {% endfor %}
</div>
{% endblock %}

{% block struct_colors %}
{
  {% for entity in session.get('placing_entities', []) %}
  "{{ entity.entity_id }}": "{{ entity.color }}",
  {% endfor %}
}
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  handleDrawCallback = function(x, y, changes, initialMap, rows, cols) {
    const structType = document.getElementById("structType").value;
    const key = `${x},${y}`;
    
    // Check if position is valid (not a wall and not occupied)
    if (initialMap[key] === 'wall') {
      return; // Can't place on walls
    }
    
    // Check if position is already occupied
    for (let existingKey in changes) {
      if (changes[existingKey] === structType) {
        delete changes[existingKey]; // Remove previous position
      }
    }
    
    changes[key] = structType;
  };
</script>
{% endblock %}
