<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warehouse Layout Optimizer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <header>
    </header>
    
    <main>
        <div class="container">
            <h1>Select Configuration</h1>
        {% block subheading %}{% endblock %}
    <div class="config-grid" style="display: flex; gap: 1rem;">
        <div class="config-section" style="display: inline-block;">
          <canvas id="canvas" style="display: block;"></canvas>
        </div>
  
        <div class="config-section" style="flex: 1;">
          <label for="structType">Currently Drawing:</label>
          <select id="structType">
            <option value="wall">üß± Wall</option>
            <option value="loading">üì¶ Loading struct</option>
            <option value="ex">‚õî Exit Only</option>
            <option value="ent">üö™ Entrance Only</option>
            <option value="ex_ent">üö™‚ÜîÔ∏è Entrance & Exit</option>
            <option value="erase">üßΩ Eraser Tool</option>
          </select>
  
          <div class="legend">
            <h3>Legend</h3>
            <div><span style="background-color: #333;"></span> Wall </div>
            <div><span style="background-color: orange;"></span> Loading struct </div>
            <div><span style="background-color: lightcoral;"></span> Exit Only</div>
            <div><span style="background-color: lime;"></span> Entrance Only</div>
            <div><span style="background-color: lightblue;"></span> Entrance & Exit</div>
          </div>
        </div>
      </div>
    </div>
    <div class="proceed-button-container">

      <form id="structureForm" method="POST" action="/structure">
        <input type="hidden" name="layout_data" id="layoutData">
        <button type="submit" class="button">Proceed</button>
      </form>
    </div>
    </main>
    
    <footer>
        <p>Powered by Mesa and Flask</p>
    </footer>

    <script>
        const canvas = document.getElementById("structCanvas");
        const ctx = canvas.getContext("2d");
        const rows = {{session.get('config').get('warehouse_width')}} + 2;
        const cols = {{session.get('config').get('warehouse_width')}} + 2;

        const maxCanvasSize = 800;
        const cellSize = Math.floor(maxCanvasSize / Math.max(rows, cols));
        canvas.width = cols * cellSize;
        canvas.height = rows * cellSize;

        const structColors = {
            wall: '#333',
            loading: 'orange',
            ex: 'lightcoral',
            ent: 'lime',
            ex_ent: 'lightblue'
        };

        

        const structMap = {};

        function drawGrid() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            for (let key in structMap) {
            const [x, y] = key.split(',').map(Number);
            const struct = structMap[key];
            ctx.fillStyle = structColors[struct] || '#fff';
            ctx.fillRect(x * cellSize, y * cellSize, cellSize, cellSize);
            }

            ctx.strokeStyle = "#ccc";
            for (let i = 0; i <= cols; i++) {
            ctx.beginPath();
            ctx.moveTo(i * cellSize, 0);
            ctx.lineTo(i * cellSize, canvas.height);
            ctx.stroke();
            }
            for (let j = 0; j <= rows; j++) {
            ctx.beginPath();
            ctx.moveTo(0, j * cellSize);
            ctx.lineTo(canvas.width, j * cellSize);
            ctx.stroke();
            }
        }

        function isEdge(x, y) {
            return x === 0 || y === 0 || x === cols - 1 || y === rows - 1;
        }

        function handleDraw(x, y) {
            const structType = document.getElementById("structType").value;
            const key = `${x},${y}`;

            if (structType === "erase") {
            if (!isEdge(x, y)) {
                delete structMap[key];
            } else {
                structMap[key] = "wall"
            }
            } else if (["ex", "ent", "ex_ent"].includes(structType)) {
            if (structMap[key] === "wall") {
                structMap[key] = structType;
            }
            } else {
            structMap[key] = structType;
            }

            drawGrid();
        }

        let isDrawing = false;

        canvas.addEventListener("mousedown", (e) => {
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            const x = Math.floor((e.clientX - rect.left) / cellSize);
            const y = Math.floor((e.clientY - rect.top) / cellSize);
            handleDraw(x, y);
        });

        canvas.addEventListener("mousemove", (e) => {
            if (isDrawing) {
            const rect = canvas.getBoundingClientRect();
            const x = Math.floor((e.clientX - rect.left) / cellSize);
            const y = Math.floor((e.clientY - rect.top) / cellSize);
            handleDraw(x, y);
            }
        });

        window.addEventListener("mouseup", () => isDrawing = false);

        document.getElementById("structureForm").addEventListener("submit", function (e) {
            const layoutJSON = JSON.stringify(structMap);
            document.getElementById("layoutData").value = layoutJSON;
        });
            
        {% block scripts %}{% endblock %}
    
        drawGrid();
    </script>
</body>
</html>